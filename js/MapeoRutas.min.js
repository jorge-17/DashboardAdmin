!function(a){a(window.jQuery,window,document)}(function($,window,document){const rootURL="https://wsi01.sctslp.gob.mx/wcf/Dashboard.svc/",mapRutas="ConsultarRutas",ciudadesRutas="ConsultarCiudades",guardarRutas="GuardarRuta",actualizarRutas="ActualizarRuta",consultarRutasId="ConsultarRutaId",consultarTrazo="ConsultarTrazo",consultarRutasUpdate="ConsultarRutasUpdate",consultarModalidades="ConsultarModalidades",consultarLineas="ConsultarLineas",tokenSession=sessionStorage.getItem("token");var g,map=null,polyLine,tmpPolyLine,flightPath,markers,vmarkers,nomRuta,ciudadRuta,modalidadRuta,des,trazo="";const latGlobal=21.256712,lngGlobal=-98.786337;var imageNormal,imageHover;$("#horaInit").datetimepicker({format:"HH:mm"}),$("#horaEnd").datetimepicker({format:"HH:mm"}),$("#horaInitEditar").datetimepicker({format:"HH:mm"}),$("#horaEndEditar").datetimepicker({format:"HH:mm"});var totRegMR=0;async function cargaInfo(){var resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+ciudadesRutas,data:JSON.stringify({token:tokenSession,idEstado:24}),contentType:"application/json; charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d),totRegCR=datos.iRegistros;for(var i=0;i<totRegCR;i++){const item=datos.aoData[i],idCiudad=item.IdCiudad,nombreCiudad=item.Nombre;$("#lstCiudades").append('<option value="'+idCiudad+'">'+nombreCiudad+"</option>"),$("#lstCiudadesVer").append('<option value="'+idCiudad+'">'+nombreCiudad+"</option>"),$("#lstCiudadesEditar").append('<option value="'+idCiudad+'">'+nombreCiudad+"</option>")}});try{resultado=await $.ajax({type:"POST",url:rootURL+mapRutas,data:JSON.stringify({token:tokenSession}),contentType:"application/json; charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d),totRegMR=datos.iRegistros;for(var i=0;i<totRegMR;i++){var item=datos.aoData[i],idRuta=item.IdRuta,nombreRuta=item.Nombre;$("#lstRutas").append('<option value="'+idRuta+'">'+nombreRuta+"</option>"),$("#lstRutasVer").append('<option value="'+idRuta+'">'+nombreRuta+"</option>"),$("#lstRutasEditar").append('<option value="'+idRuta+'">'+nombreRuta+"</option>")}});try{resultado=await $.ajax({type:"POST",url:rootURL+consultarModalidades,data:JSON.stringify({token:tokenSession}),contentType:"application/json; charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d),totRegMRModalidad=datos.iRegistros;for(var i=0;i<totRegMRModalidad;i++){var item=datos.aoData[i],idModalidad=item.IdModalidad,nombreModalidad=item.Nombre;$("#lstModalidad").append('<option value="'+idModalidad+'">'+nombreModalidad+"</option>"),$("#lstModalidadVer").append('<option value="'+idModalidad+'">'+nombreModalidad+"</option>"),$("#lstModalidadEditar").append('<option value="'+idModalidad+'">'+nombreModalidad+"</option>")}});try{resultado=await $.ajax({type:"POST",url:rootURL+consultarLineas,data:JSON.stringify({token:tokenSession}),contentType:"application/json; charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d),totRegMRLinea=datos.iRegistros;for(var i=0;i<totRegMRLinea;i++){const item=datos.aoData[i],idLinea=item.IdLinea,claveLinea=item.Clave,nombreLinea=item.Nombre;$("#lstLineas").append('<option value="'+idLinea+'">'+claveLinea+" - "+nombreLinea+"</option>"),$("#lstLineasVer").append('<option value="'+idLinea+'">'+claveLinea+" - "+nombreLinea+"</option>"),$("#lstLineasEditar").append('<option value="'+idLinea+'">'+claveLinea+" - "+nombreLinea+"</option>")}})}var initMap=function(mapHolder,lat,lng){g=google.maps,markers=[],vmarkers=[];var mapOptions={zoom:15,center:new g.LatLng(lat,lng),mapTypeId:g.MapTypeId.roadmap,draggableCursor:"auto",draggingCursor:"move",disableDoubleClickZoom:!0};map=new g.Map(document.getElementById(mapHolder),mapOptions),g.event.addListener(map,"click",mapLeftClick),mapHolder=null,mapOptions=null};function addItemList(lat,lng){const lista=document.getElementById("itemsLst"),string=lat.toFixed(5)+", "+lng.toFixed(5);console.log(string);const item=document.createElement("li");item.appendChild(document.createTextNode(string)),lista.appendChild(item)}var initPolyline=function(mapHolder){const polyOptions={strokeColor:"#3355ff",strokeOpacity:.8,strokeWeight:4},tmpPolyOptions={strokeColor:"#3355FF",strokeOpacity:.4,strokeWeight:4};(polyLine=new g.Polyline(polyOptions)).setMap(mapHolder),(tmpPolyLine=new g.Polyline(tmpPolyOptions)).setMap(mapHolder)},mapLeftClick=function(event){if(event.latLng){var marker=createMarker(event.latLng);if(markers.push(marker),1!==markers.length){var vmarker=createVMarker(event.latLng);vmarkers.push(vmarker),vmarker=null}const path=polyLine.getPath();path.push(event.latLng),marker=null}event=null},createMarker=function(point){const imageNormal=new g.MarkerImage("../img/square.png",new g.Size(11,11),new g.Point(0,0),new g.Point(6,6)),imageHover=new g.MarkerImage("../img/square_over.png",new g.Size(11,11),new g.Point(0,0),new g.Point(6,6)),marker=new g.Marker({position:point,map:map,icon:imageNormal,draggable:!0});return g.event.addListener(marker,"mouseover",function(){marker.setIcon(imageHover)}),g.event.addListener(marker,"mouseout",function(){marker.setIcon(imageNormal)}),g.event.addListener(marker,"drag",function(){for(var m=0;m<markers.length;m++)if(markers[m]===marker){polyLine.getPath().setAt(m,marker.getPosition()),moveVMarker(m);break}m=null}),g.event.addListener(marker,"click",function(){for(var m=0;m<markers.length;m++)if(markers[m]===marker){marker.setMap(null),markers.splice(m,1),polyLine.getPath().removeAt(m),removeVMarkers(m);break}m=null}),marker},createVMarker=function(point){const imageNormal=new g.MarkerImage("../img/square_transparent.png",new g.Size(11,11),new g.Point(0,0),new g.Point(6,6)),imageHover=new g.MarkerImage("../img/square_transparent_over.png",new g.Size(11,11),new g.Point(0,0),new g.Point(6,6)),prevpoint=markers[markers.length-2].getPosition();var marker=new g.Marker({position:new g.LatLng(point.lat()-.5*(point.lat()-prevpoint.lat()),point.lng()-.5*(point.lng()-prevpoint.lng())),map:map,icon:imageNormal,draggable:!0});return g.event.addListener(marker,"mouseover",function(){marker.setIcon(imageHover)}),g.event.addListener(marker,"mouseout",function(){marker.setIcon(imageNormal)}),g.event.addListener(marker,"dragstart",function(){for(var m=0;m<vmarkers.length;m++)if(vmarkers[m]===marker){var tmpPath=tmpPolyLine.getPath();tmpPath.push(markers[m].getPosition()),tmpPath.push(vmarkers[m].getPosition()),tmpPath.push(markers[m+1].getPosition());break}m=null}),g.event.addListener(marker,"drag",function(){for(var m=0;m<vmarkers.length;m++)if(vmarkers[m]===marker){tmpPolyLine.getPath().setAt(1,marker.getPosition());break}m=null}),g.event.addListener(marker,"dragend",function(){for(var m=0;m<vmarkers.length;m++)if(vmarkers[m]===marker){var newpos=marker.getPosition(),startMarkerPos=markers[m].getPosition(),firstVPos=new g.LatLng(newpos.lat()-.5*(newpos.lat()-startMarkerPos.lat()),newpos.lng()-.5*(newpos.lng()-startMarkerPos.lng())),endMarkerPos=markers[m+1].getPosition(),secondVPos=new g.LatLng(newpos.lat()-.5*(newpos.lat()-endMarkerPos.lat()),newpos.lng()-.5*(newpos.lng()-endMarkerPos.lng())),newVMarker=createVMarker(secondVPos);newVMarker.setPosition(secondVPos);var newMarker=createMarker(newpos);markers.splice(m+1,0,newMarker),polyLine.getPath().insertAt(m+1,newpos),marker.setPosition(firstVPos),vmarkers.splice(m+1,0,newVMarker),tmpPolyLine.getPath().removeAt(2),tmpPolyLine.getPath().removeAt(1),tmpPolyLine.getPath().removeAt(0),newpos=null,startMarkerPos=null,firstVPos=null,endMarkerPos=null,secondVPos=null,newVMarker=null,newMarker=null;break}}),marker},moveVMarker=function(index){var newpos=markers[index].getPosition();if(0!==index){var prevpos=markers[index-1].getPosition();vmarkers[index-1].setPosition(new g.LatLng(newpos.lat()-.5*(newpos.lat()-prevpos.lat()),newpos.lng()-.5*(newpos.lng()-prevpos.lng()))),prevpos=null}if(index!==markers.length-1){var nextpos=markers[index+1].getPosition();vmarkers[index].setPosition(new g.LatLng(newpos.lat()-.5*(newpos.lat()-nextpos.lat()),newpos.lng()-.5*(newpos.lng()-nextpos.lng()))),nextpos=null}newpos=null,index=null},removeVMarkers=function(index){if(markers.length>0&&(index!=markers.length?(vmarkers[index].setMap(null),vmarkers.splice(index,1)):(vmarkers[index-1].setMap(null),vmarkers.splice(index-1,1))),0!==index&&index!==markers.length){var prevpos=markers[index-1].getPosition(),newpos=markers[index].getPosition();vmarkers[index-1].setPosition(new g.LatLng(newpos.lat()-.5*(newpos.lat()-prevpos.lat()),newpos.lng()-.5*(newpos.lng()-prevpos.lng()))),prevpos=null,newpos=null}index=null};$("#btnsaveRuta").on("click",async function(){const path=polyLine.getPath(),ptnsPath=path.length;if(0!==ptnsPath){nomRuta=$("#nombreRuta").val(),ciudadRuta=$("#lstCiudades").val(),modalidadRuta=$("#lstModalidad").val(),lineaRuta=$("#lstLineas").val(),horaInicio=$("#horaInit").val().split(" "),horaFin=$("#horaEnd").val().split(" "),des=$("#descrip").val();for(var i=0;i<ptnsPath;i++){const item=path.getAt(i),lat=item.lat().toFixed(5),lng=item.lng().toFixed(5);var string=lat+", "+lng;trazo=i===ptnsPath-1?trazo+lat+","+lng:trazo+lat+","+lng+"|"}var dataJson=JSON.stringify({nomRuta:nomRuta,idCiudad:ciudadRuta,idModalidad:modalidadRuta,puntos:trazo,idLinea:lineaRuta,horaInicio:horaInicio[0],horaFin:horaFin[0],descripcion:des,token:tokenSession}),resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+guardarRutas,data:dataJson,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){$("#formCreateRuta")[0].reset(),initMap("mapcontainer",21.256712,lngGlobal),new PNotify.success({title:"Exito!",text:"La ruta se ha registrado correctamente",styling:"bootstrap4",delay:2e3})}),trazo=""}else new PNotify.error({title:"La ruta no ha sido definida",text:"Verifica que hayas ingresado una ruta en el mapa",styling:"bootstrap4",delay:2e3})}),$("#btnupdateRuta").on("click",async function(){var path=polyLine.getPath(),ptnsPath=path.length,idRutaGet=$("#lstRutasEditar").val();nomRuta=$("#nombreRutaEditar").val(),ciudadRuta=$("#lstCiudadesEditar").val(),modalidadRuta=$("#lstModalidadEditar").val(),lineaRuta=$("#lstLineasEditar").val(),horaInicio=$("#horaInitEditar").val().split(" "),horaFin=$("#horaEndEditar").val().split(" "),des=$("#descripEditar").val();for(var i=0;i<ptnsPath;i++){var item=path.getAt(i),lat=item.lat().toFixed(5),lng=item.lng().toFixed(5),string=lat+", "+lng;trazo=i==ptnsPath-1?trazo+lat+","+lng:trazo+lat+","+lng+"|"}var dataJson=JSON.stringify({idRuta:idRutaGet,nomRuta:nomRuta,idCiudad:ciudadRuta,idModalidad:modalidadRuta,puntos:trazo,idLinea:lineaRuta,horaInicio:horaInicio[0],horaFin:horaFin[0],descripcion:des,token:tokenSession}),resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+actualizarRutas,data:dataJson,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){$("#formEditRuta")[0].reset(),initMap("mapcontainer",21.256712,lngGlobal),new PNotify.success({title:"Exito!",text:"La ruta se ha actualizado correctamente",styling:"bootstrap4",delay:2e3})}),trazo=""}),$("#lstRutas").on("change",async function(){var idRutaGet=$("#lstRutas").val();flightPath=new google.maps.Polyline({geodesic:!0,strokeColor:"#3355FF",strokeOpacity:.8,strokeWeight:3});var dataJson=JSON.stringify({idRuta:idRutaGet,token:tokenSession}),resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+consultarRutasId,data:dataJson,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d);var itemData=datos.aoData;$("#nombreRutaVer").val(itemData[0].Nombre),$("#lstLineasVer").val(itemData[0].IdLinea),$("#lstCiudadesVer").val(itemData[0].IdCiudad),$("#lstModalidadVer").val(itemData[0].IdModalidad),$("#horaInitVer").val(itemData[0].HoraInicio),$("#horaEndVer").val(itemData[0].HoraFin),$("#descripVer").val(itemData[0].Descripcion)});var dataJson1=JSON.stringify({idRuta:idRutaGet,token:tokenSession}),resultado1;try{resultado1=await $.ajax({type:"POST",url:rootURL+consultarTrazo,data:dataJson1,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado1).then(function(data){datos=JSON.parse(data.d);var itemData=datos.aoData,arrayLat=[],arrayLng=[],i=0,bounds=new google.maps.LatLngBounds;itemData.forEach(function(item){arrayLat[i]=parseFloat(item.lat),arrayLng[i]=parseFloat(item.lng);var punto=new g.LatLng(arrayLat[i],arrayLng[i]);bounds.extend(punto),i++});var minLat=Math.min(...arrayLat),maxLat,pLat=(Math.max(...arrayLat)-minLat)/2+minLat,minLng=Math.min(...arrayLng),maxLng=Math.max(...arrayLng),pLng;initMap("mapcontainer",pLat,(maxLng-minLng)/2+minLng),flightPath.setPath(itemData),flightPath.setMap(map),map.fitBounds(bounds)})}),$("#lstRutasEditar").on("change",async function(){var idRutaGet=$("#lstRutasEditar").val();flightPath=new google.maps.Polyline({geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2});var dataJson=JSON.stringify({idRuta:idRutaGet,token:tokenSession}),resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+consultarRutasId,data:dataJson,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){datos=JSON.parse(data.d);var itemData=datos.aoData;$("#nombreRutaEditar").val(itemData[0].Nombre),$("#horaInitEditar").val(itemData[0].HoraInicio),$("#horaEndEditar").val(itemData[0].HoraFin),$("#lstLineasEditar").val(itemData[0].IdLinea),$("#lstCiudadesEditar").val(itemData[0].IdCiudad),$("#lstModalidadEditar").val(itemData[0].IdModalidad),$("#descripEditar").val(itemData[0].Descripcion)});var dataJson1=JSON.stringify({idRuta:idRutaGet,token:tokenSession}),resultado1;try{resultado1=await $.ajax({type:"POST",url:rootURL+consultarTrazo,data:dataJson1,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado1).then(function(data){datos=JSON.parse(data.d);var itemData=datos.aoData,arrayLat=[],arrayLng=[],j=0;itemData.forEach(function(item){arrayLat[j]=parseFloat(item.lat),arrayLng[j]=parseFloat(item.lng),j++});var minLat=Math.min(...arrayLat),maxLat,pLat=(Math.max(...arrayLat)-minLat)/2+minLat,minLng=Math.min(...arrayLng),maxLng=Math.max(...arrayLng),pLng;initMap("mapcontainer",pLat,(maxLng-minLng)/2+minLng),initPolyline(map);for(var bounds=new google.maps.LatLngBounds,i=0;i<arrayLat.length;i++){var punto=new g.LatLng(arrayLat[i],arrayLng[i]),marker=createMarker(punto),path;if(markers.push(marker),1!=markers.length){var vmarker=createVMarker(punto);vmarkers.push(vmarker),vmarker=null}polyLine.getPath().push(punto),marker=null,bounds.extend(punto)}map.fitBounds(bounds)})}),setInterval(async function(){var dataJson=JSON.stringify({TotalRegistros:totRegMR,token:tokenSession}),resultado;try{resultado=await $.ajax({type:"POST",url:rootURL+consultarRutasUpdate,data:dataJson,contentType:"application/json;charset=utf-8"})}catch(error){console.log(error)}$.when(resultado).then(function(data){var item;datos=JSON.parse(data.d),null!=datos.aoData&&($("#lstRutas").find("option").remove().end().append("<option></option>"),$("#lstRutasEditar").find("option").remove().end().append("<option></option>"),cargaInfo())})},3e3),$("#tabSeeRoute").on("click",function(){initMap("mapcontainer",21.256712,-98.786337),initPolyline(map),$("#formSeeRuta").find("input:text, select, textarea").val("")}),$("#tabCreateRoute").on("click",function(){initMap("mapcontainer",21.256712,-98.786337),initPolyline(map),$("#formCreateRuta").find("input:text, select, textarea").val("")}),$("#tabEditRoute").on("click",function(){initMap("mapcontainer",21.256712,-98.786337),initPolyline(map),$("#formEditRuta").find("input:text, select, textarea").val("")}),window.onload=function(){initMap("mapcontainer",21.256712,-98.786337),initPolyline(map),cargaInfo()}});